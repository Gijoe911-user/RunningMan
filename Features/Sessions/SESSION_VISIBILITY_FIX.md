# üîß Correction : Visibilit√© des Sessions

**Date :** 30 d√©cembre 2024  
**Probl√®me :** Les sessions cr√©√©es par les membres ne sont pas visibles par les autres coureurs

---

## üîç Diagnostic du Probl√®me

### Sympt√¥mes Observ√©s

1. ‚ùå **Bouton "+" non visible** pour les membres non-propri√©taires de la squad
2. ‚ùå **Sessions cr√©√©es non synchronis√©es** : quand un simple coureur cr√©e une session via le bouton carte, les autres membres ne la voient pas

### Causes Identifi√©es

#### Cause 1 : Restriction de Cr√©ation (R√©solu ‚úÖ)
**Avant :**
```swift
// SessionsListView.swift - Toolbar
.disabled(squadsVM.selectedSquad == nil)
// ‚ùå Aucune logique de r√¥le, mais le bouton est toujours visible
```

**Apr√®s :**
```swift
.disabled(!canCreateSession)

private var canCreateSession: Bool {
    guard let squad = squadsVM.selectedSquad,
          let userId = AuthService.shared.currentUserId else {
        return false
    }
    
    // Autoriser le cr√©ateur de la squad
    if squad.creatorId == userId {
        return true
    }
    
    // Autoriser les admins
    if let role = squad.members[userId], role == .admin {
        return true
    }
    
    // ‚úÖ CONFIGURATION ACTUELLE: Tous les membres peuvent cr√©er (recommand√©)
    return squad.members[userId] != nil
    
    // üîí ALTERNATIVE: Restreindre aux admins uniquement
    // return false
}
```

#### Cause 2 : Probl√®me de Synchronisation Firebase (√Ä CORRIGER ‚ö†Ô∏è)

**Hypoth√®se :**
Les sessions sont cr√©√©es localement mais :
1. Ne sont pas √©crites correctement dans Firestore
2. Ne d√©clenchent pas l'observation en temps r√©el des autres clients
3. Le champ `status` n'est pas correctement d√©fini

---

## üéØ Solutions Appliqu√©es

### ‚úÖ Solution 1 : Autoriser Tous les Membres √† Cr√©er des Sessions

**Fichier modifi√© :** `SessionsListView.swift`

**Changement :**
- Ajout de la computed property `canCreateSession`
- Modification du bouton toolbar pour prendre en compte les r√¥les
- **Configuration actuelle :** Tous les membres peuvent cr√©er (ligne `return squad.members[userId] != nil`)

**Comment basculer en mode "Admin uniquement" :**
```swift
// Dans SessionsListView.swift, ligne ~167
private var canCreateSession: Bool {
    // ... (garder les v√©rifications squad/userId)
    
    // üîì MODE OUVERT : D√©commenter cette ligne
    // return squad.members[userId] != nil
    
    // üîí MODE RESTREINT : Utiliser celle-ci
    return false  // Seuls cr√©ateur et admins autoris√©s
}
```

---

## ‚ö†Ô∏è Solution 2 : Corriger la Synchronisation Firebase

### V√©rifications √† Effectuer

#### 1. **V√©rifier que `SessionService.createSession()` √©crit correctement**

**Action :** Ouvrir la console Firebase et v√©rifier :

```
Collection: sessions
Document ID: <auto-generated>
{
    "squadId": "...",
    "status": "ACTIVE",     ‚Üê ‚ö†Ô∏è DOIT √äTRE "ACTIVE" (pas "waiting")
    "creatorId": "...",
    "startedAt": <Timestamp>,
    "participants": ["userId1"],
    ...
}
```

**Logs √† surveiller :**
```swift
// Dans CreateSessionView.swift, apr√®s cr√©ation
Logger.logSuccess("‚úÖ Session cr√©√©e avec succ√®s", category: .session)

// Dans Firebase Console ‚Üí Sessions
// V√©rifier que le document appara√Æt imm√©diatement
```

#### 2. **V√©rifier l'Observation en Temps R√©el**

**Fichier :** `RealtimeLocationService.swift` (ligne 64-82)

**Code actuel :**
```swift
private func observeActiveSession(for squadId: String) {
    sessionStreamTask?.cancel()
    sessionStreamTask = Task { [weak self] in
        guard let self else { return }
        for await session in sessionService.observeActiveSession(squadId: squadId) {
            await MainActor.run {
                self.activeSession = session
            }
            // (Re)brancher l'observation des runners selon la session
            if let sessionId = session?.id {
                observeRunnerLocations(sessionId: sessionId)
            } else {
                runnersStreamTask?.cancel()
                await MainActor.run {
                    self.runnerLocations = []
                }
            }
        }
    }
}
```

**‚ö†Ô∏è Probl√®me potentiel :**
Le `SessionService.observeActiveSession()` doit retourner un `AsyncStream` qui √©coute les changements Firebase en temps r√©el.

**V√©rification n√©cessaire :**
```swift
// Dans SessionService.swift (fichier non visible actuellement)
func observeActiveSession(squadId: String) -> AsyncStream<SessionModel?> {
    AsyncStream { continuation in
        // ‚úÖ DOIT utiliser addSnapshotListener()
        // ‚ùå PAS getDocument() ou getDocuments() (lecture unique)
        
        let listener = db.collection("sessions")
            .whereField("squadId", isEqualTo: squadId)
            .whereField("status", isEqualTo: "ACTIVE")
            .addSnapshotListener { snapshot, error in
                // ...
                continuation.yield(session)
            }
        
        continuation.onTermination = { _ in
            listener.remove()
        }
    }
}
```

#### 3. **V√©rifier les Indexes Firestore**

**Firebase Console ‚Üí Firestore ‚Üí Indexes**

**Indexes requis (selon FirebaseSchema.swift) :**
```
Collection: sessions
- squadId (ASC), status (ASC), startTime (DESC)
- status (ASC), startTime (DESC)
```

**Si manquants :**
1. Essayer de cr√©er une session
2. Firebase affichera un lien d'erreur dans les logs
3. Cliquer sur le lien pour cr√©er l'index automatiquement

---

## üß™ Tests de Validation

### Test 1 : Cr√©ation de Session (Simple Membre)

**√âtapes :**
1. Se connecter avec un compte **non-propri√©taire** de la squad
2. Aller sur l'onglet Sessions
3. **V√©rifier que le bouton "+"** est visible et actif
4. Cliquer sur "+" et cr√©er une session
5. Observer les logs :
   ```
   üöÄ Cr√©ation de la session...
   ‚úÖ Session cr√©√©e avec succ√®s
   ```

**R√©sultat attendu :** ‚úÖ La session est cr√©√©e

---

### Test 2 : Visibilit√© Multi-Utilisateurs

**Configuration :**
- 2 devices/simulateurs connect√©s au m√™me squad
- Device A : Simple membre
- Device B : Autre membre

**√âtapes :**
1. **Device A :** Cr√©er une session
2. **Device B :** Observer l'√©cran Sessions

**R√©sultat attendu :** 
- ‚úÖ Device B voit imm√©diatement la session appara√Ætre (gr√¢ce √† `addSnapshotListener`)
- ‚úÖ Le widget SessionStatsWidget s'affiche sur les deux devices

**Si √©chec :**
- ‚ö†Ô∏è V√©rifier les logs Firebase : "Listener not triggered"
- ‚ö†Ô∏è V√©rifier le champ `status` dans Firestore Console
- ‚ö†Ô∏è V√©rifier que `observeActiveSession()` utilise bien `addSnapshotListener`

---

### Test 3 : Synchronisation Temps R√©el

**√âtapes :**
1. Device A : Cr√©er une session
2. Device B : Rejoindre la session (s'affiche automatiquement)
3. Device A : D√©marrer le tracking GPS
4. Device B : Observer la position de Device A sur la carte

**R√©sultat attendu :**
- ‚úÖ Position de Device A visible sur Device B en temps r√©el (<5 secondes de latence)
- ‚úÖ Widget stats synchronis√©

---

## üîß Actions Recommand√©es

### Priorit√© 1 : Valider la Configuration Actuelle

1. ‚úÖ **Bouton de cr√©ation activ√©** (modifi√© dans SessionsListView.swift)
2. ‚ö†Ô∏è **Tester la cr√©ation** sur un vrai device
3. ‚ö†Ô∏è **V√©rifier Firebase Console** que le document est cr√©√© avec `status: "ACTIVE"`

### Priorit√© 2 : Si le Probl√®me Persiste

**Hypoth√®se : SessionService n'utilise pas addSnapshotListener**

**Action :**
1. Localiser `SessionService.swift` (fichier non actuellement visible)
2. V√©rifier la m√©thode `observeActiveSession(squadId:)`
3. S'assurer qu'elle utilise `.addSnapshotListener()` et pas `.getDocuments()`

**Code attendu :**
```swift
func observeActiveSession(squadId: String) -> AsyncStream<SessionModel?> {
    AsyncStream { continuation in
        Logger.log("üéß √âcoute des sessions actives pour squad: \(squadId)", category: .session)
        
        let listener = db.collection("sessions")
            .whereField("squadId", isEqualTo: squadId)
            .whereField("status", isEqualTo: SessionStatus.active.rawValue)
            .order(by: "startedAt", descending: true)
            .limit(to: 1)
            .addSnapshotListener { snapshot, error in
                if let error = error {
                    Logger.logError(error, context: "observeActiveSession", category: .session)
                    continuation.yield(nil)
                    return
                }
                
                guard let documents = snapshot?.documents, !documents.isEmpty else {
                    Logger.log("‚ÑπÔ∏è Aucune session active", category: .session)
                    continuation.yield(nil)
                    return
                }
                
                do {
                    let session = try documents[0].data(as: SessionModel.self)
                    Logger.log("üì° Session active re√ßue: \(session.id ?? "unknown")", category: .session)
                    continuation.yield(session)
                } catch {
                    Logger.logError(error, context: "decode session", category: .session)
                    continuation.yield(nil)
                }
            }
        
        continuation.onTermination = { @Sendable _ in
            listener.remove()
            Logger.log("üîå Listener de session arr√™t√©", category: .session)
        }
    }
}
```

### Priorit√© 3 : Debug Avanc√©

**Si rien ne fonctionne apr√®s les corrections ci-dessus :**

1. **Activer les logs Firebase d√©taill√©s :**
   ```swift
   // Dans AppDelegate ou @main
   FirebaseConfiguration.shared.setLoggerLevel(.debug)
   ```

2. **Logs √† surveiller :**
   ```
   üöÄ Cr√©ation de la session...
   ‚úÖ Session cr√©√©e avec succ√®s
   üéß √âcoute des sessions actives pour squad: <squadId>
   üì° Session active re√ßue: <sessionId>
   ```

3. **Console Firebase :**
   - Aller dans Firestore
   - Collection `sessions`
   - V√©rifier que le document existe avec les bons champs

---

## üìä R√©sum√© des Modifications

| Fichier | Modification | Statut |
|---------|--------------|--------|
| `SessionsListView.swift` | Ajout de `canCreateSession` computed property | ‚úÖ Fait |
| `SessionsListView.swift` | Modification du bouton toolbar | ‚úÖ Fait |
| `SessionService.swift` | √Ä v√©rifier : utilisation de `addSnapshotListener` | ‚ö†Ô∏è √Ä faire |
| Firebase Indexes | V√©rifier l'existence des indexes requis | ‚ö†Ô∏è √Ä faire |

---

## üéØ Configuration Actuelle

### Qui Peut Cr√©er des Sessions ?

**‚úÖ Configuration actuelle :** **Tous les membres de la squad**

**Comment changer :**
```swift
// Dans SessionsListView.swift, ligne ~167

// üîì OPTION 1 : Tous les membres (ACTUEL)
return squad.members[userId] != nil

// üîí OPTION 2 : Seulement propri√©taire et admins
return false
```

### Visibilit√© des Sessions

**Comportement attendu :**
- Une session cr√©√©e par **n'importe quel membre** doit √™tre **visible par tous** les membres de la squad
- La synchronisation se fait en **temps r√©el** via Firebase Realtime Listeners

---

## üìû Prochaines √âtapes

1. ‚úÖ **Tester la cr√©ation** avec un membre non-propri√©taire
2. ‚ö†Ô∏è **V√©rifier Firebase Console** que la session est cr√©√©e
3. ‚ö†Ô∏è **Tester avec 2 devices** que la synchronisation fonctionne
4. ‚ö†Ô∏è **Si √©chec :** Examiner `SessionService.swift` pour valider l'impl√©mentation de `observeActiveSession()`

---

**Besoin d'aide ?**
1. V√©rifier les logs Xcode pour les erreurs Firebase
2. Partager les logs de cr√©ation de session
3. Partager le code de `SessionService.swift` si le probl√®me persiste

---

**Date de derni√®re mise √† jour :** 30 d√©cembre 2024
